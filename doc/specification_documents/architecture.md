# アーキテクチャ設計書

## 1. システム概要

### 1.1 システム構成
- **アプリケーションタイプ**: デスクトップアプリケーション（Webベース）
- **アーキテクチャパターン**: MVCパターン（Taipyフレームワーク内）
- **実行環境**: ローカル環境（将来的にはクラウド対応も検討）

### 1.2 技術スタック
- **フロントエンド/バックエンド統合フレームワーク**: Taipy
  - Taipy GUI: ユーザーインターフェース
  - Taipy Core: ワークフロー管理
- **データベース**: SQLite
- **言語**: Python 3.9+
- **依存ライブラリ**:
  - pandas: データ処理
  - plotly: データ可視化
  - networkx: 依存関係グラフ処理

## 2. アプリケーション層設計

### 2.1 レイヤー構成
- **プレゼンテーション層**:
  - Taipy GUIページ定義
  - ビジュアルコンポーネント
  - イベントハンドラ
- **ビジネスロジック層**:
  - プロジェクト管理ロジック
  - タスク管理ロジック
  - バッファ計算ロジック
  - 時間トラッキングロジック
  - 分析ロジック
- **データアクセス層**:
  - データモデル
  - リポジトリクラス
  - クエリビルダー

### 2.2 モジュール構成
```
ccpm/
├── app.py                  # アプリケーションエントリーポイント
├── config.py               # 設定ファイル
├── pages/                  # Taipy GUIページ定義
│   ├── dashboard.py
│   ├── projects.py
│   ├── tasks.py
│   ├── time_tracking.py
│   └── analysis.py
├── models/                 # データモデル
│   ├── project.py
│   ├── task.py
│   ├── time_record.py
│   ├── regular_task.py
│   └── estimation_history.py
├── services/               # ビジネスロジック
│   ├── project_service.py
│   ├── task_service.py
│   ├── buffer_service.py
│   ├── time_service.py
│   └── analysis_service.py
├── repositories/           # データアクセス
│   ├── base_repository.py
│   ├── project_repository.py
│   ├── task_repository.py
│   └── time_repository.py
├── utils/                  # ユーティリティ
│   ├── date_utils.py
│   ├── estimation_utils.py
│   └── visualization_utils.py
└── db/                     # データベース関連
    ├── db_manager.py
    ├── migrations/
    └── backup/
```

## 3. データフロー

### 3.1 基本データフロー
1. ユーザーがGUIで操作を実行
2. Taipy GUIイベントハンドラがサービス層のメソッドを呼び出し
3. サービス層がビジネスロジックを実行し、必要に応じてリポジトリを使用
4. リポジトリがデータベースとのやり取りを担当
5. 結果がサービス層を経由してGUIに返され、表示が更新される

### 3.2 主要データフロー例
- **プロジェクト作成フロー**:
  ```
  GUI入力 → ProjectService.create_project() → ProjectRepository.save() → DB
  ```
- **タスク開始フロー**:
  ```
  GUI操作 → TaskService.start_task() → TimeService.create_record() → TimeRepository.save() → DB
  ```
- **バッファ消費計算フロー**:
  ```
  定期実行 → BufferService.calculate_buffer_consumption() → ProjectRepository.update() → DB → GUI更新
  ```

## 4. 技術的詳細

### 4.1 Taipyフレームワーク活用
- **Taipy GUI**:
  - マークダウンベースのレイアウト定義
  - リアクティブな変数バインディング
  - コンポーネントライブラリの活用
- **Taipy Core** (将来拡張):
  - ワークフロー定義
  - スケジューリング
  - シナリオ管理

### 4.2 データベース設計
- **SQLite採用理由**:
  - 軽量で設定不要
  - 単一ファイルベースで移植性が高い
  - 個人利用に十分なパフォーマンス
- **テーブル設計**: データモデル仕様書に準拠
- **インデックス戦略**: 頻繁に検索される列にインデックスを設定

### 4.3 非同期処理
- **バックグラウンド処理**:
  - 時間トラッキングの自動記録
  - 定期的なバッファ状態計算
  - バックアップ処理
- **実装方法**:
  - Pythonのthreadingモジュール
  - スケジュールされたタスク

## 5. セキュリティ設計

### 5.1 認証・認可
- **初期MVP**: ローカル認証なし（単一ユーザー想定）
- **将来拡張**:
  - Google認証連携
  - JWTトークン管理

### 5.2 データ保護
- **ローカルデータ暗号化**:
  - SQLiteデータベースファイルの暗号化（オプション）
- **バックアップ保護**:
  - バックアップファイルのパスワード保護

## 6. 拡張性と保守性

### 6.1 拡張ポイント
- **プラグイン機構**:
  - カスタム分析モジュール
  - 外部サービス連携
- **設定のカスタマイズ**:
  - ユーザー設定ファイル
  - テーマとレイアウトのカスタマイズ

### 6.2 コード品質維持
- **テスト戦略**:
  - ユニットテスト（pytest）
  - 統合テスト
  - GUIテスト
- **コード規約**:
  - PEP 8準拠
  - タイプヒント活用
  - ドキュメンテーション規約

## 7. デプロイメント

### 7.1 パッケージング
- **配布形式**:
  - Python wheel (.whl)
  - スタンドアロン実行ファイル（PyInstaller）
- **依存関係管理**:
  - requirements.txt
  - setup.py

### 7.2 インストール手順
- **開発環境**:
  ```
  git clone <repository>
  cd ccpm
  pip install -e .
  python -m ccpm
  ```
- **エンドユーザー**:
  ```
  pip install ccpm-tool
  ccpm
  ```

## 8. 段階的実装計画

### 8.1 MVP第1弾アーキテクチャ
- **コア機能のみ実装**:
  - 基本的なデータモデル
  - シンプルなGUIページ
  - 最小限のビジネスロジック
- **技術的制約**:
  - 単一ユーザー
  - ローカルデータベースのみ
  - 基本的な可視化

### 8.2 MVP第2弾アーキテクチャ拡張
- **追加機能**:
  - 拡張分析機能
  - 高度なバッファ管理
  - データエクスポート/インポート
- **技術的拡張**:
  - 高度な可視化
  - バックアップ/リストア機能

### 8.3 MVP第3弾アーキテクチャ拡張
- **追加機能**:
  - 定常タスク管理の完全実装
  - 高度な予実管理
  - 詳細レポート
- **技術的拡張**:
  - データマイグレーション機能
  - 設定のカスタマイズ 